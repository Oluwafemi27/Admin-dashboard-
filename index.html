<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #ffffff0f;
    --accent: #7c6dfa;
    --accent2: #fa6d8a;
    --accent3: #6dfabd;
    --text: #f0f0f8;
    --muted: #6b6b88;
    --danger: #fa4d6d;
    --warning: #fab84d;
    --success: #4dfaab;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ GRID BG ‚îÄ‚îÄ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(124,109,250,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(124,109,250,0.03) 1px, transparent 1px);
    background-size: 48px 48px;
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
  #login-screen {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    background: var(--bg);
  }

  .login-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 48px 40px;
    width: 380px;
    position: relative;
    overflow: hidden;
    animation: slideUp 0.5s ease;
  }

  .login-box::before {
    content: '';
    position: absolute;
    top: -60px; left: -60px;
    width: 180px; height: 180px;
    background: radial-gradient(circle, rgba(124,109,250,0.2), transparent 70%);
    pointer-events: none;
  }

  .login-box h1 {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 6px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .login-box p { color: var(--muted); font-size: 14px; margin-bottom: 32px; }

  .field { margin-bottom: 16px; }
  .field label { display: block; font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 8px; letter-spacing: 0.08em; text-transform: uppercase; }
  .field input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .field input:focus { border-color: var(--accent); }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.2s;
    text-decoration: none;
  }
  .btn-primary { background: var(--accent); color: white; width: 100%; justify-content: center; }
  .btn-primary:hover { background: #6a5de0; transform: translateY(-1px); }
  .btn-danger { background: rgba(250,77,109,0.15); color: var(--danger); border: 1px solid rgba(250,77,109,0.3); }
  .btn-danger:hover { background: rgba(250,77,109,0.25); }
  .btn-success { background: rgba(77,250,171,0.15); color: var(--success); border: 1px solid rgba(77,250,171,0.3); }
  .btn-success:hover { background: rgba(77,250,171,0.25); }
  .btn-sm { padding: 7px 14px; font-size: 12px; border-radius: 8px; }
  .btn-config { background: var(--surface2); border: 1px solid var(--border); color: var(--text); width: 100%; justify-content: center; }
  .btn-config:hover { background: rgba(255,255,255,0.08); }
  .config-clear-btn { margin-top: 8px; }

  #login-error { color: var(--danger); font-size: 13px; margin-top: 12px; display: none; font-family: 'JetBrains Mono', monospace; }

  /* ‚îÄ‚îÄ APP LAYOUT ‚îÄ‚îÄ */
  #app { display: none; height: 100vh; overflow: hidden; position: relative; z-index: 1; }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 240px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 10;
    padding: 24px 0;
  }

  .sidebar-logo {
    padding: 0 24px 28px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
  }
  .sidebar-logo span {
    font-size: 20px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: block;
  }
  .sidebar-logo small { color: var(--muted); font-size: 11px; font-family: 'JetBrains Mono', monospace; }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 24px;
    cursor: pointer;
    color: var(--muted);
    font-size: 14px;
    font-weight: 600;
    transition: all 0.15s;
    border-left: 2px solid transparent;
    margin: 1px 0;
  }
  .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.03); }
  .nav-item.active { color: var(--accent); border-left-color: var(--accent); background: rgba(124,109,250,0.08); }
  .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }

  .nav-badge {
    margin-left: auto;
    background: var(--accent2);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 20px;
    font-family: 'JetBrains Mono', monospace;
  }

  .sidebar-bottom {
    margin-top: auto;
    padding: 20px 24px 0;
    border-top: 1px solid var(--border);
  }

  .admin-badge {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-top: 16px;
  }
  .admin-avatar {
    width: 36px; height: 36px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 14px;
  }
  .admin-info small { display: block; color: var(--muted); font-size: 11px; font-family: 'JetBrains Mono'; }
  .admin-info strong { font-size: 13px; }

  /* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
  .main {
    margin-left: 240px;
    height: 100vh;
    overflow-y: auto;
    padding: 32px;
  }

  .page { display: none; animation: fadeIn 0.3s ease; }
  .page.active { display: block; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }

  /* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 32px;
  }
  .page-header h2 { font-size: 26px; font-weight: 800; }
  .page-header p { color: var(--muted); font-size: 14px; margin-top: 4px; }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.1); }
  .stat-card .glow {
    position: absolute;
    top: -30px; right: -30px;
    width: 100px; height: 100px;
    border-radius: 50%;
    opacity: 0.15;
  }
  .stat-card .label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }
  .stat-card .value { font-size: 36px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
  .stat-card .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

  /* ‚îÄ‚îÄ CHARTS ROW ‚îÄ‚îÄ */
  .charts-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    margin-bottom: 28px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
  }
  .card-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .card-title span { color: var(--muted); font-size: 12px; font-weight: 400; }
  .view-all-link { cursor: pointer; color: var(--accent); }
  .view-all-link:hover { text-decoration: underline; }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 10px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }
  td {
    padding: 14px 16px;
    font-size: 13px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    vertical-align: middle;
  }
  tr:hover td { background: rgba(255,255,255,0.02); }
  tr:last-child td { border-bottom: none; }

  .tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
  }
  .tag-admin { background: rgba(124,109,250,0.2); color: var(--accent); }
  .tag-user { background: rgba(255,255,255,0.06); color: var(--muted); }
  .tag-active { background: rgba(77,250,171,0.15); color: var(--success); }
  .tag-read { background: rgba(107,107,136,0.2); color: var(--muted); }

  /* ‚îÄ‚îÄ SEARCH / FILTERS ‚îÄ‚îÄ */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }
  .search-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 16px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
    width: 480px;
    max-width: 95vw;
    animation: slideUp 0.3s ease;
  }
  .modal h3 { font-size: 20px; font-weight: 800; margin-bottom: 20px; }
  .modal .field { margin-bottom: 14px; }
  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

  /* ‚îÄ‚îÄ NOTIFICATION COMPOSE ‚îÄ‚îÄ */
  .notif-compose {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
  }
  .notif-compose h4 { font-size: 14px; font-weight: 700; margin-bottom: 16px; }
  textarea {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    outline: none;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s;
  }
  textarea:focus { border-color: var(--accent); }

  select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 16px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    outline: none;
    cursor: pointer;
  }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast {
    position: fixed;
    bottom: 32px; right: 32px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 20px;
    font-size: 14px;
    z-index: 999;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 320px;
  }
  #toast.show { transform: translateY(0); opacity: 1; }
  #toast.success { border-color: rgba(77,250,171,0.3); }
  #toast.error { border-color: rgba(250,77,109,0.3); }

  /* ‚îÄ‚îÄ SUPABASE CONFIG BANNER ‚îÄ‚îÄ */
  .config-banner {
    background: rgba(250,184,77,0.1);
    border: 1px solid rgba(250,184,77,0.3);
    border-radius: 12px;
    padding: 14px 18px;
    font-size: 13px;
    color: var(--warning);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'JetBrains Mono', monospace;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* ‚îÄ‚îÄ ACTIVITY FEED ‚îÄ‚îÄ */
  .activity-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .activity-item:last-child { border-bottom: none; }
  .activity-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-top: 5px;
    flex-shrink: 0;
  }
  .activity-item .time { font-size: 11px; color: var(--muted); font-family: 'JetBrains Mono'; margin-top: 2px; }

  /* ‚îÄ‚îÄ LOGOUT BTN ‚îÄ‚îÄ */
  .logout-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
    color: var(--muted);
    font-size: 13px;
    font-weight: 600;
    transition: all 0.15s;
    margin-top: 12px;
    border: 1px solid transparent;
  }
  .logout-btn:hover { color: var(--danger); border-color: rgba(250,77,109,0.2); background: rgba(250,77,109,0.05); }

  /* ‚îÄ‚îÄ SETUP GUIDE ‚îÄ‚îÄ */
  .setup-steps { counter-reset: step; }
  .setup-step {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 20px 20px 60px;
    margin-bottom: 12px;
    position: relative;
    counter-increment: step;
  }
  .setup-step::before {
    content: counter(step);
    position: absolute;
    left: 20px; top: 20px;
    width: 28px; height: 28px;
    background: var(--accent);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 13px;
    line-height: 28px;
    text-align: center;
  }
  .setup-step h4 { font-size: 14px; font-weight: 700; margin-bottom: 6px; }
  .setup-step code {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    display: block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--accent3);
    margin-top: 10px;
    overflow-x: auto;
    white-space: pre;
  }
  .setup-step p { font-size: 13px; color: var(--muted); }

  .inline-input {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  .inline-input input { flex: 1; }

  /* ‚îÄ‚îÄ CONFIG SECTION ‚îÄ‚îÄ */
  .config-section {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }
  .config-label {
    font-size: 12px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    margin-bottom: 10px;
  }
  .config-display {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    font-size: 12px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    word-break: break-all;
  }

  @media (max-width: 900px) {
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .charts-row { grid-template-columns: 1fr; }
    .sidebar { width: 200px; }
    .main { margin-left: 200px; padding: 20px; }
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-box">
    <h1>Admin Panel</h1>
    <p>Sign in with your admin credentials</p>
    <div class="field">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="admin@yourapp.com"/>
    </div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <button class="btn btn-primary" onclick="doLogin()">Sign In ‚Üí</button>
    <div id="login-error">‚ö† Invalid credentials or not an admin</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <span>‚ö° AdminOS</span>
      <small>Connected to Supabase</small>
    </div>

    <div class="nav-item active" onclick="showPage('dashboard',this)">
      <span class="icon">‚óà</span> Dashboard
    </div>
    <div class="nav-item" onclick="showPage('users',this)">
      <span class="icon">‚óâ</span> Users
      <span class="nav-badge" id="badge-users">‚Äî</span>
    </div>
    <div class="nav-item" onclick="showPage('accounts',this)">
      <span class="icon">‚óé</span> Accounts
      <span class="nav-badge" id="badge-accounts">‚Äî</span>
    </div>
    <div class="nav-item" onclick="showPage('messages',this)">
      <span class="icon">‚óê</span> Messages
      <span class="nav-badge" id="badge-messages">‚Äî</span>
    </div>
    <div class="nav-item" onclick="showPage('notifications',this)">
      <span class="icon">‚óë</span> Notifications
    </div>
    <div class="nav-item" onclick="showPage('setup',this)">
      <span class="icon">‚ó´</span> Setup Guide
    </div>

    <div class="sidebar-bottom">
      <div class="admin-badge">
        <div class="admin-avatar" id="admin-avatar">A</div>
        <div class="admin-info">
          <strong id="admin-name">Admin</strong>
          <small>Super Admin</small>
        </div>
      </div>
      <div class="logout-btn" onclick="doLogout()">‚èª Sign Out</div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main">

    <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div>
          <h2>Dashboard</h2>
          <p>Welcome back. Here's what's happening.</p>
        </div>
        <button class="btn btn-success btn-sm" onclick="refreshAll()">‚Üª Refresh</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="glow" style="background:var(--accent)"></div>
          <div class="label">Total Users</div>
          <div class="value" id="stat-users">‚Äî</div>
          <div class="sub">registered accounts</div>
        </div>
        <div class="stat-card">
          <div class="glow" style="background:var(--accent2)"></div>
          <div class="label">Bank Accounts</div>
          <div class="value" id="stat-accounts">‚Äî</div>
          <div class="sub">submitted details</div>
        </div>
        <div class="stat-card">
          <div class="glow" style="background:var(--accent3)"></div>
          <div class="label">Messages</div>
          <div class="value" id="stat-messages">‚Äî</div>
          <div class="sub">total sent</div>
        </div>
        <div class="stat-card">
          <div class="glow" style="background:var(--warning)"></div>
          <div class="label">Notifications</div>
          <div class="value" id="stat-notifs">‚Äî</div>
          <div class="sub">sent to users</div>
        </div>
      </div>

      <div class="charts-row">
        <div class="card">
          <div class="card-title">User Growth <span>Last 7 days</span></div>
          <canvas id="growth-chart" height="200"></canvas>
        </div>
        <div class="card">
          <div class="card-title">Recent Activity</div>
          <div id="activity-feed">
            <div class="empty-state"><div class="icon">‚óå</div><p>Loading activity‚Ä¶</p></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Latest Account Submissions <span class="view-all-link" onclick="showPage('accounts',document.querySelector('.nav-item:nth-child(4)'))">View all ‚Üí</span></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Name</th><th>Bank</th><th>Account #</th><th>Submitted</th></tr></thead>
            <tbody id="recent-accounts"><tr><td colspan="4" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ USERS ‚îÄ‚îÄ -->
    <div class="page" id="page-users">
      <div class="page-header">
        <div><h2>Users</h2><p>Manage all registered users</p></div>
        <button class="btn btn-primary btn-sm" onclick="loadUsers()">‚Üª Refresh</button>
      </div>
      <div class="toolbar">
        <input class="search-input" placeholder="üîç  Search by email‚Ä¶" oninput="filterUsers(this.value)"/>
        <select onchange="filterUserRole(this.value)">
          <option value="">All Roles</option>
          <option value="admin">Admin</option>
          <option value="user">User</option>
        </select>
        <div style="display:flex;align-items:center;gap:10px;margin-left:auto;background:var(--surface2);padding:6px 14px;border-radius:10px;border:1px solid var(--border)">
          <span style="font-size:12px;font-weight:700;color:var(--muted)">GLOBAL WITHDRAWALS:</span>
          <button id="global-withdrawals-btn" class="btn btn-sm" onclick="toggleGlobalWithdrawals()">Loading‚Ä¶</button>
        </div>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Email</th><th>Username</th><th>Role</th><th>Wallet Balance</th><th>Joined</th><th>Withdrawals</th><th>Actions</th></tr></thead>
            <tbody id="users-tbody"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ACCOUNTS ‚îÄ‚îÄ -->
    <div class="page" id="page-accounts">
      <div class="page-header">
        <div><h2>Bank Accounts</h2><p>Submitted account details from users</p></div>
        <button class="btn btn-primary btn-sm" onclick="loadAccounts()">‚Üª Refresh</button>
      </div>
      <div class="toolbar">
        <input class="search-input" placeholder="üîç  Search by name or bank‚Ä¶" oninput="filterAccounts(this.value)"/>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Full Name</th><th>Bank</th><th>Account Number</th><th>User ID</th><th>Submitted</th><th>Actions</th></tr></thead>
            <tbody id="accounts-tbody"><tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ -->
    <div class="page" id="page-messages">
      <div class="page-header">
        <div><h2>Messages</h2><p>All user messages</p></div>
        <button class="btn btn-primary btn-sm" onclick="loadMessages()">‚Üª Refresh</button>
      </div>
      <div class="toolbar">
        <input class="search-input" placeholder="üîç  Search messages‚Ä¶" oninput="filterMessages(this.value)"/>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>From</th><th>To</th><th>Message</th><th>Status</th><th>Sent</th><th>Actions</th></tr></thead>
            <tbody id="messages-tbody"><tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ -->
    <div class="page" id="page-notifications">
      <div class="page-header">
        <div><h2>Notifications</h2><p>Send and manage user notifications</p></div>
      </div>

      <div class="notif-compose">
        <h4>üì¢ Send New Notification</h4>
        <div class="field">
          <label>Title</label>
          <input type="text" id="notif-title" class="search-input" style="width:100%" placeholder="e.g. System Update"/>
        </div>
        <div class="field" style="margin-top:12px">
          <label>Message Body</label>
          <textarea id="notif-body" placeholder="Write your notification message here‚Ä¶"></textarea>
        </div>
        <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
          <select id="notif-target">
            <option value="all">üì£ All Users</option>
            <option value="specific">üë§ Specific User (enter ID below)</option>
          </select>
          <input type="text" id="notif-user-id" class="search-input" style="flex:1" placeholder="User ID (if specific user)"/>
          <button class="btn btn-primary" onclick="sendNotification()">Send ‚Üí</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Sent Notifications</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Title</th><th>Body</th><th>User</th><th>Read</th><th>Sent At</th><th>Actions</th></tr></thead>
            <tbody id="notifs-tbody"><tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SETUP GUIDE ‚îÄ‚îÄ -->
    <div class="page" id="page-setup">
      <div class="page-header">
        <div><h2>Setup Guide</h2><p>Connect this dashboard to your Supabase project</p></div>
      </div>

      <div class="config-banner">‚ö† Configure your Supabase credentials on the login screen before using the dashboard.</div>

      <div class="setup-steps">
        <div class="setup-step">
          <h4>Create the required tables in Supabase</h4>
          <p>Go to Supabase ‚Üí SQL Editor and run this SQL:</p>
          <code>-- Profiles table (extends Supabase auth.users)
CREATE TABLE IF NOT EXISTS profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT,
  username TEXT,
  role TEXT DEFAULT 'user',
  wallet_balance DECIMAL(18,2) DEFAULT 0.00,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Wallets table (for withdrawal status)
CREATE TABLE IF NOT EXISTS wallets (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  withdrawals_enabled BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Account details
CREATE TABLE IF NOT EXISTS accounts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  account_number TEXT NOT NULL,
  full_name TEXT NOT NULL,
  bank_name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Messages
CREATE TABLE IF NOT EXISTS messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  sender_id UUID REFERENCES auth.users(id),
  receiver_id UUID REFERENCES auth.users(id),
  content TEXT NOT NULL,
  read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Notifications
CREATE TABLE IF NOT EXISTS notifications (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID,
  title TEXT NOT NULL,
  body TEXT NOT NULL,
  read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- App Settings (Global toggle)
CREATE TABLE IF NOT EXISTS settings (
  key TEXT PRIMARY KEY,
  value JSONB,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
INSERT INTO settings (key, value) VALUES ('withdrawals_enabled', 'true') ON CONFLICT DO NOTHING;</code>
        </div>

        <div class="setup-step">
          <h4>Auto-create profile on signup</h4>
          <p>Run this in SQL Editor to auto-populate profiles when a user registers:</p>
          <code>CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, role)
  VALUES (NEW.id, NEW.email, 'user');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();</code>
        </div>

        <div class="setup-step">
          <h4>Set your admin role</h4>
          <p>After signing up, run this to make yourself admin (replace the email):</p>
          <code>UPDATE profiles SET role = 'admin' WHERE email = 'your-email@example.com';</code>
        </div>

        <div class="setup-step">
          <h4>Get your Supabase credentials</h4>
          <p>Go to Supabase ‚Üí Project Settings ‚Üí API. Copy your Project URL and <strong>service_role</strong> key. Enter them on the login screen config section. The service_role key bypasses RLS so the admin can see all data.</p>
        </div>

        <div class="setup-step">
          <h4>Deploy this dashboard (Termux)</h4>
          <code>pkg install nodejs git
npm install -g serve
serve -s . -l 3000
# OR deploy to Vercel:
npm install -g vercel
vercel --prod</code>
        </div>

        <div class="setup-step">
          <h4>Connect your Lovable app to new tables</h4>
          <p>In your Lovable app, use the Supabase client to read/write to the new tables. The connection string stays the same ‚Äî just add queries for <code style="display:inline;padding:2px 6px;border-radius:4px;background:var(--bg)">accounts</code>, <code style="display:inline;padding:2px 6px;border-radius:4px;background:var(--bg)">messages</code>, and <code style="display:inline;padding:2px 6px;border-radius:4px;background:var(--bg)">notifications</code>.</p>
        </div>

        <div class="setup-step">
          <h4>Fix Schema Issues (If Getting Column Errors)</h4>
          <p>If you see errors about missing columns, run this SQL in your Supabase SQL editor:</p>
          <code>-- Add missing body column to notifications table (if it doesn't exist)
ALTER TABLE notifications ADD COLUMN IF NOT EXISTS body TEXT;

-- Verify notifications table structure
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'notifications'
ORDER BY ordinal_position;</code>
          <p style="margin-top:10px;color:var(--warning)">If the column still doesn't appear after running this, drop and recreate the entire table using the SQL from Step 1.</p>
        </div>

        <div class="setup-step">
          <h4>Test Connection & Sync</h4>
          <p>Click the button below to test your Supabase connection and verify that all changes are syncing properly. Check your browser console (F12) for detailed logs.</p>
          <button class="btn btn-success" onclick="testSupabaseConnection()" style="margin-top:12px">Test Connection</button>
          <div id="diagnostics-output" style="margin-top:12px;background:var(--bg);padding:12px;border-radius:6px;display:none;font-family:'JetBrains Mono';font-size:12px;line-height:1.6;max-height:300px;overflow-y:auto;color:var(--muted)"></div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- EDIT USER MODAL -->
<div class="modal-overlay" id="edit-user-modal">
  <div class="modal">
    <h3>Edit User</h3>
    <input type="hidden" id="edit-user-id"/>
    <div class="field"><label>Email</label><input type="email" id="edit-user-email" class="search-input" style="width:100%"/></div>
    <div class="field" style="margin-top:12px"><label>Username</label><input type="text" id="edit-user-username" class="search-input" style="width:100%"/></div>
    <div class="field" style="margin-top:12px">
      <label>Role</label>
      <select id="edit-user-role" style="width:100%">
        <option value="user">user</option>
        <option value="admin">admin</option>
      </select>
    </div>
    <div class="field" style="margin-top:12px"><label>Wallet Balance</label><input type="number" id="edit-user-wallet" class="search-input" style="width:100%" step="0.01" min="0"/></div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeModal('edit-user-modal')">Cancel</button>
      <button class="btn btn-success" onclick="saveUser()">Save Changes</button>
    </div>
  </div>
</div>

<!-- EDIT ACCOUNT MODAL -->
<div class="modal-overlay" id="edit-account-modal">
  <div class="modal">
    <h3>Edit Account Details</h3>
    <input type="hidden" id="edit-acc-id"/>
    <div class="field"><label>Full Name</label><input type="text" id="edit-acc-name" class="search-input" style="width:100%"/></div>
    <div class="field" style="margin-top:12px"><label>Bank Name</label><input type="text" id="edit-acc-bank" class="search-input" style="width:100%"/></div>
    <div class="field" style="margin-top:12px"><label>Account Number</label><input type="text" id="edit-acc-num" class="search-input" style="width:100%"/></div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeModal('edit-account-modal')">Cancel</button>
      <button class="btn btn-success" onclick="saveAccount()">Save Changes</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let SUPABASE_URL = 'https://agrqjflxaouzqfdtokxq.supabase.co';
let SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFncnFqZmx4YW91enFmZHRva3hxIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTk0NTU0NCwiZXhwIjoyMDg3NTIxNTQ0fQ.4DmNb5z44oboi1HMr8YA_dDNakYOYekYHg4icroFPqs';
let allUsers = [], allAccounts = [], allMessages = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE API HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sb(path, opts = {}) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': opts.prefer || 'return=representation',
      ...opts.headers
    },
    method: opts.method || 'GET',
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.message || `HTTP ${res.status}`);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : [];
}

// Count helper
async function sbCount(table) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=*`, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Prefer': 'count=exact',
      'Range': '0-0'
    }
  });
  const range = res.headers.get('content-range') || '0/0';
  return parseInt(range.split('/')[1]) || 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';

  try {
    console.log('üîê Login attempt:', { email, supabaseUrl: SUPABASE_URL });

    // Sign in via Supabase Auth
    const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error_description || 'Auth failed');

    console.log('‚úÖ Auth successful, user ID:', data.user.id);

    // Check admin role
    const profile = await sb(`profiles?user_id=eq.${data.user.id}&select=role`);
    console.log('üìã Profile query result:', profile);

    if (!profile.length) {
      throw new Error('Profile not found in database. Make sure your admin account exists and the profiles table is set up correctly.');
    }
    if (profile[0].role !== 'admin') {
      throw new Error(`Your role is "${profile[0].role}", but only "admin" can access this dashboard. Ask your database admin to set your role to admin.`);
    }

    // Set admin info
    document.getElementById('admin-name').textContent = email.split('@')[0];
    document.getElementById('admin-avatar').textContent = email[0].toUpperCase();

    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initRealtime();
    refreshAll();

  } catch(e) {
    errEl.textContent = '‚ö† ' + e.message;
    errEl.style.display = 'block';
  }
}

function doLogout() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if(el) el.classList.add('active');

  // Load data lazily
  if(name === 'users') loadUsers();
  if(name === 'accounts') loadAccounts();
  if(name === 'messages') loadMessages();
  if(name === 'notifications') loadNotifications();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REFRESH ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function refreshAll() {
  await Promise.all([loadStats(), loadRecentAccounts(), loadGrowthChart(), loadActivity()]);
}

async function loadStats() {
  try {
    const [u, a, m, n] = await Promise.all([
      sbCount('profiles'),
      sbCount('accounts'),
      sbCount('messages'),
      sbCount('notifications')
    ]);
    document.getElementById('stat-users').textContent = u;
    document.getElementById('stat-accounts').textContent = a;
    document.getElementById('stat-messages').textContent = m;
    document.getElementById('stat-notifs').textContent = n;
    document.getElementById('badge-users').textContent = u;
    document.getElementById('badge-accounts').textContent = a;
    document.getElementById('badge-messages').textContent = m;
  } catch(e) { console.warn('Stats error:', e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHART
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let growthChartInst = null;
async function loadGrowthChart() {
  try {
    const users = await sb('profiles?select=created_at&order=created_at.asc&limit=200');
    const days = {};
    const now = new Date();
    for(let i=6; i>=0; i--) {
      const d = new Date(now); d.setDate(d.getDate()-i);
      days[d.toISOString().split('T')[0]] = 0;
    }
    users.forEach(u => {
      const day = u.created_at?.split('T')[0];
      if(days[day] !== undefined) days[day]++;
    });
    const labels = Object.keys(days).map(d => { const dt = new Date(d); return dt.toLocaleDateString('en',{weekday:'short'}); });
    const data = Object.values(days);

    const ctx = document.getElementById('growth-chart').getContext('2d');
    if(growthChartInst) growthChartInst.destroy();
    growthChartInst = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'New Users',
          data,
          borderColor: '#7c6dfa',
          backgroundColor: 'rgba(124,109,250,0.1)',
          tension: 0.4,
          fill: true,
          pointBackgroundColor: '#7c6dfa',
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b6b88' } },
          y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b6b88', stepSize: 1 } }
        }
      }
    });
  } catch(e) { console.warn('Chart error:', e.message); }
}

async function loadActivity() {
  const feed = document.getElementById('activity-feed');
  try {
    const [users, msgs, accs] = await Promise.all([
      sb('profiles?select=email,created_at&order=created_at.desc&limit=3'),
      sb('messages?select=content,created_at&order=created_at.desc&limit=3'),
      sb('accounts?select=full_name,created_at&order=created_at.desc&limit=3')
    ]);
    const items = [
      ...users.map(u => ({ color: '#7c6dfa', text: `New user: ${u.email}`, time: u.created_at })),
      ...msgs.map(m => ({ color: '#6dfabd', text: `Message: "${m.content?.slice(0,30)}‚Ä¶"`, time: m.created_at })),
      ...accs.map(a => ({ color: '#fa6d8a', text: `Account submitted: ${a.full_name}`, time: a.created_at })),
    ].sort((a,b) => new Date(b.time) - new Date(a.time)).slice(0,6);

    feed.innerHTML = items.length ? items.map(i => `
      <div class="activity-item">
        <div class="activity-dot" style="background:${i.color}"></div>
        <div>
          <div style="font-size:13px">${i.text}</div>
          <div class="time">${timeAgo(i.time)}</div>
        </div>
      </div>`).join('') : '<div class="empty-state"><div class="icon">‚óå</div><p>No recent activity</p></div>';
  } catch(e) { feed.innerHTML = '<div class="empty-state"><p>Could not load activity</p></div>'; }
}

async function loadRecentAccounts() {
  const tbody = document.getElementById('recent-accounts');
  try {
    const data = await sb('accounts?select=*&order=created_at.desc&limit=5');
    tbody.innerHTML = data.length ? data.map(a => `
      <tr>
        <td>${a.full_name}</td>
        <td>${a.bank_name}</td>
        <td style="font-family:'JetBrains Mono';font-size:12px">${a.account_number}</td>
        <td style="color:var(--muted);font-size:12px">${timeAgo(a.created_at)}</td>
      </tr>`).join('') : `<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:30px">No accounts yet</td></tr>`;
  } catch(e) { tbody.innerHTML = `<tr><td colspan="4" style="color:var(--danger);padding:20px">Error: ${e.message}</td></tr>`; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let globalWithdrawalsEnabled = true;

async function loadUsers() {
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr>`;
  try {
    // Load Global Setting
    try {
      const settings = await sb('settings?key=eq.withdrawals_enabled');
      if (settings.length > 0) {
        globalWithdrawalsEnabled = settings[0].value === true || settings[0].value === 'true';
        updateGlobalWithdrawalsBtn();
      }
    } catch(e) { console.warn('Settings table error:', e.message); }

    // Attempt to load profiles
    allUsers = await sb('profiles?order=created_at.desc');
    console.log('Loaded users:', allUsers);

    if (allUsers.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:40px">No users found. Check if profiles table exists and has data.</td></tr>`;
      return;
    }

    // Try to enrich with wallets data
    try {
      const wallets = await sb('wallets?select=user_id,withdrawals_enabled');
      allUsers = allUsers.map(u => {
        const wallet = wallets.find(w => w.user_id === u.id);
        return { ...u, wallets: wallet ? [wallet] : [] };
      });
      console.log('Enriched users with wallets data:', allUsers);
    } catch(e) {
      console.warn('Could not load wallets data:', e.message);
    }

    renderUsers(allUsers);
  } catch(e2) {
    console.error('Load users error:', e2);
    tbody.innerHTML = `<tr><td colspan="7" style="color:var(--danger);padding:20px">Error: ${e2.message}</td></tr>`;
  }
}

function updateGlobalWithdrawalsBtn() {
  const btn = document.getElementById('global-withdrawals-btn');
  if (!btn) return;
  btn.textContent = globalWithdrawalsEnabled ? 'ACTIVE' : 'DISABLED';
  btn.className = `btn btn-sm ${globalWithdrawalsEnabled ? 'btn-success' : 'btn-danger'}`;
}

async function toggleGlobalWithdrawals() {
  const newState = !globalWithdrawalsEnabled;
  try {
    console.log('Attempting to update global withdrawals setting to:', newState);
    await sb('settings?key=eq.withdrawals_enabled', {
      method: 'PATCH',
      body: { value: newState }
    });
    globalWithdrawalsEnabled = newState;
    updateGlobalWithdrawalsBtn();
    console.log('‚úì Global withdrawals setting updated successfully:', newState);
    toast(`‚úì Global withdrawals ${newState ? 'enabled' : 'disabled'}`, 'success');
  } catch(e) {
    // Try insert if patch fails
    try {
      console.log('PATCH failed, attempting POST:', e.message);
      await sb('settings', {
        method: 'POST',
        body: { key: 'withdrawals_enabled', value: newState },
        prefer: 'return=minimal'
      });
      globalWithdrawalsEnabled = newState;
      updateGlobalWithdrawalsBtn();
      console.log('‚úì Global withdrawals setting created successfully:', newState);
      toast(`‚úì Global withdrawals ${newState ? 'enabled' : 'disabled'}`, 'success');
    } catch(e2) {
      console.error('Failed to update global withdrawals:', e2.message);
      toast('Error updating withdrawals: ' + e2.message, 'error');
    }
  }
}

function renderUsers(data) {
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = data.length ? data.map(u => {
    const wStatus = u.wallets && u.wallets[0] ? u.wallets[0].withdrawals_enabled : (u.withdrawals_enabled !== undefined ? u.withdrawals_enabled : true);
    return `
    <tr>
      <td>${u.email || '‚Äî'}</td>
      <td>${u.username || '‚Äî'}</td>
      <td><span class="tag tag-${u.role === 'admin' ? 'admin' : 'user'}">${u.role || 'user'}</span></td>
      <td style="font-family:'JetBrains Mono';font-size:12px">$${parseFloat(u.wallet_balance || 0).toFixed(2)}</td>
      <td style="color:var(--muted);font-size:12px">${fmt(u.created_at)}</td>
      <td>
        <button class="btn ${wStatus ? 'btn-success' : 'btn-danger'} btn-sm" onclick="toggleUserWithdrawals('${u.user_id}', ${!wStatus})" style="min-width:80px">
          ${wStatus ? 'ACTIVE' : 'DISABLED'}
        </button>
      </td>
      <td>
        <button class="btn btn-success btn-sm" onclick="openEditUser('${u.id}','${u.username || u.email}','${u.username || ''}','${u.role||'user'}','${u.wallet_balance || 0}')">Edit</button>
        <button class="btn btn-danger btn-sm" style="margin-left:6px" onclick="deleteUser('${u.id}')">Delete</button>
      </td>
    </tr>`;
  }).join('') : `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:40px">No users found</td></tr>`;
}

async function toggleUserWithdrawals(userId, enabled) {
  try {
    console.log(`Toggling withdrawals for user ${userId} to:`, enabled);
    // Check if user has a wallet record first, or just try to update
    const result = await sb(`wallets?user_id=eq.${userId}`, {
      method: 'PATCH',
      body: { withdrawals_enabled: enabled }
    });

    // If no record was updated, we might need to insert one
    if (!result || result.length === 0) {
      console.log(`No wallet found for user ${userId}, creating new record`);
      await sb('wallets', {
        method: 'POST',
        body: { user_id: userId, withdrawals_enabled: enabled },
        prefer: 'return=minimal'
      });
    }

    console.log(`‚úì User ${userId} withdrawal status updated successfully:`, enabled);
    toast(`‚úì Withdrawals ${enabled ? 'enabled' : 'disabled'}`, 'success');
    loadUsers();
  } catch(e) {
    // Fallback: try updating profiles table if wallets table doesn't exist
    try {
      console.log(`Wallet update failed, falling back to profiles table:`, e.message);
      await sb(`profiles?user_id=eq.${userId}`, {
        method: 'PATCH',
        body: { withdrawals_enabled: enabled }
      });
      console.log(`‚úì User ${userId} withdrawal status updated in profiles:`, enabled);
      toast(`‚úì Withdrawals ${enabled ? 'enabled' : 'disabled'} (in profiles)`, 'success');
      loadUsers();
    } catch(e2) {
      console.error('Failed to update user withdrawal status:', e2.message);
      toast('Error: ' + e2.message, 'error');
    }
  }
}

function filterUsers(q) { renderUsers(allUsers.filter(u => (u.username || u.email)?.toLowerCase().includes(q.toLowerCase()))); }
function filterUserRole(r) { renderUsers(r ? allUsers.filter(u => (u.role||'user') === r) : allUsers); }

function openEditUser(id, email, username, role, wallet) {
  document.getElementById('edit-user-id').value = id;
  document.getElementById('edit-user-email').value = email;
  document.getElementById('edit-user-username').value = username;
  document.getElementById('edit-user-role').value = role;
  document.getElementById('edit-user-wallet').value = wallet;
  document.getElementById('edit-user-modal').classList.add('open');
}

async function saveUser() {
  const id = document.getElementById('edit-user-id').value;
  const email = document.getElementById('edit-user-email').value;
  const username = document.getElementById('edit-user-username').value;
  const role = document.getElementById('edit-user-role').value;
  const wallet_balance = parseFloat(document.getElementById('edit-user-wallet').value) || 0;
  try {
    console.log('Saving user:', { id, email, username, role, wallet_balance });
    // Update profiles table
    await sb(`profiles?id=eq.${id}`, { method: 'PATCH', body: { username, role, wallet_balance } });
    console.log('‚úì User saved successfully:', id);
    toast('‚úì User updated!', 'success');
    closeModal('edit-user-modal');
    loadUsers();
  } catch(e) {
    toast('Error: ' + e.message, 'error');
    console.error('Save user error:', e.message);
  }
}

async function deleteUser(id) {
  if(!confirm('Delete this user? This cannot be undone.')) return;
  try {
    await sb(`profiles?id=eq.${id}`, { method: 'DELETE', prefer: 'return=minimal' });
    toast('User deleted', 'success');
    loadUsers();
    loadStats();
  } catch(e) { toast('Error: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACCOUNTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAccounts() {
  const tbody = document.getElementById('accounts-tbody');
  tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr>`;
  try {
    // Load global settings
    try {
      const settings = await sb('settings?key=eq.withdrawals_enabled');
      if (settings.length > 0) {
        globalWithdrawalsEnabled = settings[0].value === true || settings[0].value === 'true';
      }
    } catch(e) { console.warn('Settings table error:', e.message); }

    allAccounts = await sb('accounts?select=*&order=created_at.desc');
    renderAccounts(allAccounts);
  } catch(e) { tbody.innerHTML = `<tr><td colspan="6" style="color:var(--danger);padding:20px">Error: ${e.message}</td></tr>`; }
}

function renderAccounts(data) {
  const tbody = document.getElementById('accounts-tbody');
  const withdrawalsStatus = globalWithdrawalsEnabled ? '' : `<tr><td colspan="6" style="background-color:var(--danger);color:white;padding:15px;text-align:center;font-weight:bold">‚ö†Ô∏è  Global Withdrawals are DISABLED - Accounts cannot be edited</td></tr>`;

  const tableRows = data.length ? data.map(a => `
    <tr>
      <td>${a.full_name}</td>
      <td>${a.bank_name}</td>
      <td style="font-family:'JetBrains Mono';font-size:12px">${a.account_number}</td>
      <td style="font-family:'JetBrains Mono';font-size:11px;color:var(--muted)">${a.user_id?.slice(0,8)}‚Ä¶</td>
      <td style="color:var(--muted);font-size:12px">${fmt(a.created_at)}</td>
      <td>
        <button class="btn btn-success btn-sm" onclick="openEditAccount('${a.id}','${a.full_name}','${a.bank_name}','${a.account_number}')" ${!globalWithdrawalsEnabled ? 'disabled' : ''}>Edit</button>
        <button class="btn btn-danger btn-sm" style="margin-left:6px" onclick="deleteAccount('${a.id}')" ${!globalWithdrawalsEnabled ? 'disabled' : ''}>Delete</button>
      </td>
    </tr>`).join('') : `<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:40px">No accounts submitted yet</td></tr>`;

  tbody.innerHTML = withdrawalsStatus + tableRows;
}

function filterAccounts(q) {
  const f = q.toLowerCase();
  renderAccounts(allAccounts.filter(a => a.full_name?.toLowerCase().includes(f) || a.bank_name?.toLowerCase().includes(f)));
}

function openEditAccount(id, name, bank, num) {
  if (!globalWithdrawalsEnabled) {
    toast('Cannot edit accounts while global withdrawals are disabled', 'error');
    return;
  }
  document.getElementById('edit-acc-id').value = id;
  document.getElementById('edit-acc-name').value = name;
  document.getElementById('edit-acc-bank').value = bank;
  document.getElementById('edit-acc-num').value = num;
  document.getElementById('edit-account-modal').classList.add('open');
}

async function saveAccount() {
  if (!globalWithdrawalsEnabled) {
    toast('Cannot save accounts while global withdrawals are disabled', 'error');
    return;
  }
  const id = document.getElementById('edit-acc-id').value;
  const full_name = document.getElementById('edit-acc-name').value;
  const bank_name = document.getElementById('edit-acc-bank').value;
  const account_number = document.getElementById('edit-acc-num').value;

  try {
    console.log('Saving account:', { id, full_name, bank_name, account_number });
    await sb(`accounts?id=eq.${id}`, {
      method: 'PATCH',
      body: { full_name, bank_name, account_number }
    });
    console.log('‚úì Account saved successfully:', id);
    closeModal('edit-account-modal');
    toast('‚úì Account updated!', 'success');
    loadAccounts();
  } catch(e) {
    console.error('Save account error:', e.message);
    toast('Error: ' + e.message, 'error');
  }
}

async function deleteAccount(id) {
  if (!globalWithdrawalsEnabled) {
    toast('Cannot delete accounts while global withdrawals are disabled', 'error');
    return;
  }
  if(!confirm('Delete this account record?')) return;
  try {
    await sb(`accounts?id=eq.${id}`, { method: 'DELETE', prefer: 'return=minimal' });
    toast('Account deleted', 'success');
    loadAccounts();
    loadStats();
  } catch(e) { toast('Error: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadMessages() {
  const tbody = document.getElementById('messages-tbody');
  tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr>`;
  try {
    allMessages = await sb('messages?select=*&order=created_at.desc');
    renderMessages(allMessages);
  } catch(e) { tbody.innerHTML = `<tr><td colspan="6" style="color:var(--danger);padding:20px">Error: ${e.message}</td></tr>`; }
}

function renderMessages(data) {
  const tbody = document.getElementById('messages-tbody');
  tbody.innerHTML = data.length ? data.map(m => `
    <tr>
      <td style="font-family:'JetBrains Mono';font-size:11px;color:var(--muted)">${m.sender_id?.slice(0,8)}‚Ä¶</td>
      <td style="font-family:'JetBrains Mono';font-size:11px;color:var(--muted)">${m.receiver_id?.slice(0,8) || 'broadcast'}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.content}</td>
      <td><span class="tag ${m.read ? 'tag-read' : 'tag-active'}">${m.read ? 'read' : 'unread'}</span></td>
      <td style="color:var(--muted);font-size:12px">${fmt(m.created_at)}</td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="deleteMessage('${m.id}')">Delete</button>
      </td>
    </tr>`).join('') : `<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:40px">No messages yet</td></tr>`;
}

function filterMessages(q) {
  const f = q.toLowerCase();
  renderMessages(allMessages.filter(m => m.content?.toLowerCase().includes(f)));
}

async function deleteMessage(id) {
  if(!confirm('Delete this message?')) return;
  try {
    await sb(`messages?id=eq.${id}`, { method: 'DELETE', prefer: 'return=minimal' });
    toast('Message deleted', 'success');
    loadMessages();
  } catch(e) { toast('Error: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadNotifications() {
  const tbody = document.getElementById('notifs-tbody');
  tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">Loading‚Ä¶</td></tr>`;
  try {
    const data = await sb('notifications?select=*&order=created_at.desc');
    tbody.innerHTML = data.length ? data.map(n => `
      <tr>
        <td style="font-weight:700">${n.title}</td>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${n.body}</td>
        <td style="font-family:'JetBrains Mono';font-size:11px;color:var(--muted)">${n.user_id?.slice(0,8) || 'all'}‚Ä¶</td>
        <td><span class="tag ${n.read ? 'tag-read' : 'tag-active'}">${n.read ? 'read' : 'unread'}</span></td>
        <td style="color:var(--muted);font-size:12px">${fmt(n.created_at)}</td>
        <td>
          <button class="btn btn-danger btn-sm" onclick="deleteNotif('${n.id}')">Delete</button>
        </td>
      </tr>`).join('') : `<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:40px">No notifications sent yet</td></tr>`;
  } catch(e) { tbody.innerHTML = `<tr><td colspan="6" style="color:var(--danger);padding:20px">Error: ${e.message}</td></tr>`; }
}

async function sendNotification() {
  const title = document.getElementById('notif-title').value.trim();
  const body = document.getElementById('notif-body').value.trim();
  const target = document.getElementById('notif-target').value;
  const userId = document.getElementById('notif-user-id').value.trim();

  if(!title || !body) { toast('Title and body are required', 'error'); return; }

  try {
    console.log('üì§ Sending notification...', { title, body, target, userId });

    if(target === 'all') {
      // Get all users and send to each
      console.log('üìã Fetching all users...');
      const users = await sb('profiles?select=id');
      console.log(`üë• Found ${users.length} users`);
      const inserts = users.map(u => ({ user_id: u.id, title, body }));
      // Batch insert
      console.log('üìÆ Inserting notifications...', inserts[0]);
      await sb('notifications', { method: 'POST', body: inserts, prefer: 'return=minimal' });
      console.log(`‚úì Notifications inserted successfully for ${users.length} users`);
      toast(`‚úì Notification sent to ${users.length} users!`, 'success');
    } else {
      if(!userId) { toast('Please enter a User ID', 'error'); return; }
      const payload = { user_id: userId, title, body };
      console.log(`üìÆ Inserting notification for user: ${userId}`, payload);
      await sb('notifications', { method: 'POST', body: payload, prefer: 'return=minimal' });
      console.log('‚úì Notification inserted successfully');
      toast('‚úì Notification sent!', 'success');
    }
    document.getElementById('notif-title').value = '';
    document.getElementById('notif-body').value = '';
    loadNotifications();
    loadStats();
  } catch(e) {
    console.error('‚ùå Notification error:', e);
    console.error('Full error details:', {
      message: e.message,
      code: e.code,
      details: e.details,
      hint: e.hint
    });

    // Check if it's a schema/column issue
    if(e.message && e.message.includes('body')) {
      toast('Error: The "body" column is missing from the notifications table. Check the Setup Guide and run the migration SQL.', 'error');
    } else {
      toast('Error: ' + e.message, 'error');
    }
  }
}

async function deleteNotif(id) {
  try {
    await sb(`notifications?id=eq.${id}`, { method: 'DELETE', prefer: 'return=minimal' });
    toast('Notification deleted', 'success');
    loadNotifications();
  } catch(e) { toast('Error: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = (type === 'success' ? '‚úì ' : '‚úï ') + msg;
  el.className = 'show ' + type;
  setTimeout(() => { el.className = ''; }, 3000);
}

function fmt(iso) {
  if(!iso) return '‚Äî';
  return new Date(iso).toLocaleDateString('en', { year:'numeric', month:'short', day:'numeric' });
}

function timeAgo(iso) {
  if(!iso) return '‚Äî';
  const diff = (Date.now() - new Date(iso)) / 1000;
  if(diff < 60) return 'just now';
  if(diff < 3600) return `${Math.floor(diff/60)}m ago`;
  if(diff < 86400) return `${Math.floor(diff/3600)}h ago`;
  return `${Math.floor(diff/86400)}d ago`;
}

async function testSupabaseConnection() {
  const output = document.getElementById('diagnostics-output');
  output.style.display = 'block';
  output.innerHTML = '<span style="color:var(--muted)">Testing...</span>';

  let log = [];
  const addLog = (msg, type = 'info') => {
    const icon = type === 'error' ? '‚úï' : type === 'success' ? '‚úì' : '‚Üí';
    const color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--muted)';
    log.push(`<span style="color:${color}">${icon} ${msg}</span>`);
  };

  try {
    addLog('Starting connection test...', 'info');

    // Test basic connectivity
    addLog('Supabase URL: ' + SUPABASE_URL);
    const hasKey = SUPABASE_KEY ? 'Yes (hidden)' : 'No - ERROR!';
    addLog('API Key present: ' + hasKey, SUPABASE_KEY ? 'success' : 'error');

    // Test table access
    addLog('', 'info');
    addLog('Testing table access...', 'info');

    try {
      const profiles = await sbCount('profiles');
      addLog(`Profiles table: ${profiles} records found`, 'success');
    } catch(e) {
      addLog(`Profiles table error: ${e.message}`, 'error');
    }

    try {
      const accounts = await sbCount('accounts');
      addLog(`Accounts table: ${accounts} records found`, 'success');
    } catch(e) {
      addLog(`Accounts table error: ${e.message}`, 'error');
    }

    try {
      const wallets = await sbCount('wallets');
      addLog(`Wallets table: ${wallets} records found`, 'success');
    } catch(e) {
      addLog(`Wallets table error: ${e.message}`, 'error');
    }

    try {
      const settings = await sbCount('settings');
      addLog(`Settings table: ${settings} records found`, 'success');
    } catch(e) {
      addLog(`Settings table error: ${e.message}`, 'error');
    }

    try {
      const notifications = await sbCount('notifications');
      addLog(`Notifications table: ${notifications} records found`, 'success');

      // Try to fetch one notification to verify columns exist
      try {
        const sample = await sb('notifications?limit=1');
        if(sample.length > 0) {
          const cols = Object.keys(sample[0]);
          addLog(`Notification columns: ${cols.join(', ')}`, cols.includes('body') ? 'success' : 'error');
          if(!cols.includes('body')) {
            addLog('‚ö†Ô∏è  Missing "body" column! Run the migration SQL from Setup Guide step 8.', 'error');
          }
        }
      } catch(e) {
        addLog(`Cannot verify notification columns: ${e.message}`, 'error');
      }
    } catch(e) {
      addLog(`Notifications table error: ${e.message}`, 'error');
    }

    // Test real-time status
    addLog('', 'info');
    addLog('Real-time status:', 'info');
    addLog(`Supabase client: ${supabaseClient ? 'Connected' : 'Not connected'}`, supabaseClient ? 'success' : 'error');
    addLog(`Global withdrawals enabled: ${globalWithdrawalsEnabled ? 'Yes' : 'No'}`, 'success');

    addLog('', 'info');
    addLog('All tests completed! Check browser console for more details.', 'success');

  } catch(e) {
    addLog('Test failed: ' + e.message, 'error');
  }

  output.innerHTML = log.join('<br>');
  console.log('üîß Diagnostics:', log.join('\n'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REALTIME SUBSCRIPTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let supabaseClient = null;

async function initRealtime() {
  try {
    const { createClient } = window.supabase;
    supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    subscribeToRealtimeChanges();
    console.log('‚úì Real-time subscriptions initialized successfully');
    toast('Real-time sync enabled', 'success');
  } catch(e) {
    console.error('Real-time init error:', e.message);
    toast('Warning: Real-time sync failed - changes may not sync automatically', 'warning');
  }
}

function subscribeToRealtimeChanges() {
  if(!supabaseClient) return;

  // Subscribe to notifications changes
  supabaseClient.channel('notifications-changes')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'notifications'
    }, (payload) => {
      console.log('üì¨ Notifications changed:', payload.eventType);
      if(document.getElementById('page-notifications').classList.contains('active')) {
        loadNotifications();
      }
      loadStats();
    })
    .subscribe();

  // Subscribe to messages changes
  supabaseClient.channel('messages-changes')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'messages'
    }, (payload) => {
      console.log('üí¨ Messages changed:', payload.eventType);
      if(document.getElementById('page-messages').classList.contains('active')) {
        loadMessages();
      }
      loadStats();
    })
    .subscribe();

  // Subscribe to wallets changes
  supabaseClient.channel('wallets-changes')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'wallets'
    }, (payload) => {
      console.log('üí∞ Wallets changed:', payload.eventType);
      if(document.getElementById('page-users').classList.contains('active')) {
        loadUsers();
      }
    })
    .subscribe();

  // Subscribe to accounts changes
  supabaseClient.channel('accounts-changes')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'accounts'
    }, (payload) => {
      console.log('üè¶ Accounts changed:', payload.eventType);
      if(document.getElementById('page-accounts').classList.contains('active')) {
        loadAccounts();
      }
      loadStats();
    })
    .subscribe();

  // Subscribe to profiles changes
  supabaseClient.channel('profiles-changes')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'profiles'
    }, (payload) => {
      console.log('üë§ Profiles changed:', payload.eventType);
      if(document.getElementById('page-users').classList.contains('active')) {
        loadUsers();
      }
      loadStats();
    })
    .subscribe();

  // Subscribe to settings changes (global withdrawals toggle)
  supabaseClient.channel('settings-changes')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'settings'
    }, async (payload) => {
      console.log('‚öôÔ∏è  Settings changed:', payload.eventType, payload);
      try {
        const settings = await sb('settings?key=eq.withdrawals_enabled');
        if (settings.length > 0) {
          globalWithdrawalsEnabled = settings[0].value === true || settings[0].value === 'true';
          updateGlobalWithdrawalsBtn();
          // Reload accounts page if visible to reflect withdrawal status
          if(document.getElementById('page-accounts').classList.contains('active')) {
            loadAccounts();
          }
        }
      } catch(e) {
        console.warn('Error updating global withdrawal status:', e.message);
      }
    })
    .subscribe();
}
</script>
</body>
</html>
